import pandas as pd

def _blank(val):
    return "" if (val is None or (isinstance(val, float) and pd.isna(val))) else str(val)

def _fmt_intish(val):
    if val is None or (isinstance(val, float) and pd.isna(val)):
        return ""
    try:
        f = float(val)
        return str(int(f)) if f.is_integer() else str(val)
    except Exception:
        return str(val)

def _first3(val):
    s = _blank(val).strip()
    return s[:3] if s else ""

def create_regatta_resume_html(sailor_name, scraper_df, results_df, filename="regatta_resume.html", style="classic"):
    # CSS styles
    styles = {
        "classic": """
        <style>
            body { font-family: 'Times New Roman', serif; margin: 40px; color: #2c3e50; }
            h1 { font-size: 24px; color: #1f618d; }
            h2 { font-size: 18px; margin-top: 24px; color: #1f618d; border-bottom: 2px solid #1f618d; }
            table { width: 100%; border-collapse: collapse; margin-top: 12px; }
            th { background-color: #1f618d; color: white; padding: 8px; text-align: left; }
            td { padding: 8px; border-bottom: 1px solid #ddd; }
            tr:nth-child(even) { background-color: #f2f2f2; }
        </style>
        """,
        "modern": """
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; background-color: #f8f9f9; color: #333; }
            h1 { font-size: 26px; color: #34495e; }
            h2 { font-size: 16px; margin-top: 24px; color: #2e86c1; }
            table { width: 100%; border-spacing: 0 6px; }
            th { background-color: #2e86c1; color: white; padding: 10px; }
            td { background-color: white; padding: 8px; border: 1px solid #d5dbdb; }
            tr:hover td { background-color: #eaf2f8; }
        </style>
        """,
        "minimalist": """
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            h1 { font-size: 22px; }
            h2 { font-size: 16px; margin-top: 20px; }
            table { width: 100%; border-collapse: collapse; }
            th { background-color: #3498db; color: white; padding: 6px; }
            td { border: 1px solid #ddd; padding: 6px; }
        </style>
        """
    }

    html = f"""
    <html>
    <head>
    {styles.get(style, styles["classic"])}
    <title>{sailor_name}'s Regatta Résumé</title>
    </head>
    <body>
    <h1>{_blank(sailor_name)}'s Regatta Résumé</h1>
    """

    # Techscore Section
    if scraper_df is not None and not scraper_df.empty:
        html += "<h2>Techscore Regattas</h2>"
        html += """
        <table>
        <tr><th>Class</th><th>Regatta</th><th>Date</th><th>Place</th><th>Position</th></tr>
        """
        for _, row in scraper_df.dropna(how="all").iterrows():
            html += f"""
            <tr>
                <td>{_blank(row.get("Source", ""))}</td>
                <td>{_blank(row.get("Regatta", ""))}</td>
                <td>{_blank(row.get("Date", ""))}</td>
                <td>{_fmt_intish(row.get("Place", ""))}</td>
                <td>{_blank(row.get("Result", ""))}</td>
            </tr>
            """
        html += "</table>"

    # Clubspot Section
    if results_df is not None and not results_df.empty:
        html += "<h2>Clubspot Regattas</h2>"
        html += """
        <table>
        <tr><th>Class</th><th>Regatta</th><th>Date</th><th>Place</th><th>Position</th></tr>
        """

        shaped = {"Source","Regatta","Date","Place","Result"}.issubset(set(results_df.columns))
        raw = {"Regatta Name","Start Date (UTC)","Matched Row Text"}.issubset(set(results_df.columns))

        for _, row in results_df.dropna(how="all").iterrows():
            cls = _blank(row.get("Source", "")) if shaped else ""
            reg = _blank(row.get("Regatta", "")) if shaped else _blank(row.get("Regatta Name", ""))
            date = _blank(row.get("Date", "")) if shaped else _blank(row.get("Start Date (UTC)", ""))
            res = row.get("Result") if shaped else row.get("Matched Row Text", "")
            first3 = _first3(res)

            html += f"""
            <tr>
                <td>{cls}</td>
                <td>{reg}</td>
                <td>{date}</td>
                <td>{first3}</td>
                <td>{first3}</td>
            </tr>
            """
        html += "</table>"

    html += "</body></html>"

    with open(filename, "w", encoding="utf-8") as f:
        f.write(html)

    print(f"Saved regatta résumé to {filename}!")
