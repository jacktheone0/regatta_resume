{% extends "base.html" %}

{% block title %}Admin Dashboard - RegattaResume{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">Admin Dashboard</h1>

    <!-- Scraper Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Scraper Control</h5>
                </div>
                <div class="card-body">
                    <p>Manually trigger the scraper to fetch regatta data from TheClubSpot.com</p>

                    <div class="alert alert-info">
                        <strong>Note:</strong> The scraper runs automatically every Sunday at 11:59 PM UTC.
                        Use this button to run it manually if needed.
                    </div>

                    <button id="runScraperBtn" class="btn btn-success btn-lg me-2">
                        <i class="bi bi-play-circle"></i> Run Scraper Now
                    </button>

                    <button id="stopScraperBtn" class="btn btn-danger btn-lg">
                        <i class="bi bi-stop-circle"></i> Stop Scraper
                    </button>

                    <div id="scraperStatus" class="mt-3" style="display: none;">
                        <div class="alert" id="statusMessage"></div>
                    </div>

                    <div id="scraperLogs" class="mt-3" style="display: none;">
                        <h6>Recent Scraper Runs:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Started</th>
                                        <th>Status</th>
                                        <th>Regattas</th>
                                        <th>Sailors</th>
                                        <th>Results</th>
                                    </tr>
                                </thead>
                                <tbody id="logTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Database Stats</h5>
                </div>
                <div class="card-body">
                    <div class="stat-item mb-3">
                        <div class="stat-label">Total Sailors</div>
                        <div class="stat-value">{{ stats.total_sailors }}</div>
                    </div>
                    <div class="stat-item mb-3">
                        <div class="stat-label">Total Regattas</div>
                        <div class="stat-value">{{ stats.total_regattas }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Results</div>
                        <div class="stat-value">{{ stats.total_results }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Inspector -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">üîç Table Structure Inspector</h5>
        </div>
        <div class="card-body">
            <p>Inspect the table structure of any regatta to see column headers and sample data. Useful for debugging scraper issues.</p>

            <div class="row g-3">
                <div class="col-md-8">
                    <input type="text" id="inspectRegattaId" class="form-control" placeholder="Enter regatta ID (e.g., r7bw6wf1a8)" />
                    <small class="form-text text-muted">Find regatta IDs from URLs like: theclubspot.com/regatta/<strong>r7bw6wf1a8</strong></small>
                </div>
                <div class="col-md-4">
                    <button id="inspectBtn" class="btn btn-info w-100">Inspect Table</button>
                </div>
            </div>

            <div id="inspectResults" class="mt-4" style="display: none;">
                <div id="inspectError" class="alert alert-danger" style="display: none;"></div>

                <div id="inspectData">
                    <h6>Table Information</h6>
                    <div class="mb-3">
                        <strong>URL:</strong> <a id="inspectUrl" href="#" target="_blank"></a><br>
                        <strong>Table Type:</strong> <span id="inspectTableType" class="badge bg-secondary"></span><br>
                        <strong>Columns:</strong> <span id="inspectNumCols"></span><br>
                        <strong>Sample Rows:</strong> <span id="inspectNumRows"></span>
                    </div>

                    <h6>Column Headers</h6>
                    <div id="inspectHeaders" class="mb-3">
                        <div class="d-flex flex-wrap gap-2"></div>
                    </div>

                    <h6>Sample Data (First 10 Rows)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="inspectTable">
                            <thead id="inspectTableHead"></thead>
                            <tbody id="inspectTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Quick Actions</h5>
        </div>
        <div class="card-body">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary me-2">View Site</a>
            <a href="/api/sailors" class="btn btn-outline-secondary me-2" target="_blank">API Docs</a>
        </div>
    </div>
</div>

<style>
.stat-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #0066cc;
}
</style>

<script>
document.getElementById('runScraperBtn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('scraperStatus');
    const statusMsg = document.getElementById('statusMessage');

    // Disable button
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting...';

    try {
        const response = await fetch('/api/scraper/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            statusMsg.className = 'alert alert-success';
            statusMsg.textContent = '‚úì ' + data.message + ' - Check back in a few minutes to see results.';
        } else {
            statusMsg.className = 'alert alert-danger';
            statusMsg.textContent = '‚úó Error: ' + (data.error || 'Unknown error');
        }

        statusDiv.style.display = 'block';

        // Re-enable button after 10 seconds
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-circle"></i> Run Scraper Now';
        }, 10000);

    } catch (error) {
        statusMsg.className = 'alert alert-danger';
        statusMsg.textContent = '‚úó Error: ' + error.message;
        statusDiv.style.display = 'block';

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-circle"></i> Run Scraper Now';
    }
});

// Stop scraper button handler
document.getElementById('stopScraperBtn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('scraperStatus');
    const statusMsg = document.getElementById('statusMessage');

    if (!confirm('Are you sure you want to stop the currently running scraper?')) {
        return;
    }

    // Disable button
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Stopping...';

    try {
        const response = await fetch('/api/scraper/stop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            statusMsg.className = 'alert alert-success';
            statusMsg.textContent = '‚úì ' + data.message;
        } else {
            statusMsg.className = 'alert alert-warning';
            statusMsg.textContent = '‚ö† ' + data.message;
        }

        statusDiv.style.display = 'block';

        // Re-enable button
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop Scraper';
        }, 3000);

    } catch (error) {
        statusMsg.className = 'alert alert-danger';
        statusMsg.textContent = '‚úó Error: ' + error.message;
        statusDiv.style.display = 'block';

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop Scraper';
    }
});

// Table inspector handler
document.getElementById('inspectBtn').addEventListener('click', async function() {
    const btn = this;
    const regattaId = document.getElementById('inspectRegattaId').value.trim();
    const resultsDiv = document.getElementById('inspectResults');
    const errorDiv = document.getElementById('inspectError');
    const dataDiv = document.getElementById('inspectData');

    if (!regattaId) {
        alert('Please enter a regatta ID');
        return;
    }

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Inspecting...';
    errorDiv.style.display = 'none';
    resultsDiv.style.display = 'block';
    dataDiv.style.display = 'none';

    try {
        const response = await fetch('/api/scraper/inspect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ regatta_id: regattaId })
        });

        const data = await response.json();

        if (data.error) {
            errorDiv.textContent = 'Error: ' + data.error;
            errorDiv.style.display = 'block';
            dataDiv.style.display = 'none';
        } else {
            // Display results
            document.getElementById('inspectUrl').href = data.url || '#';
            document.getElementById('inspectUrl').textContent = data.url || 'N/A';
            document.getElementById('inspectTableType').textContent = data.table_type || 'unknown';
            document.getElementById('inspectNumCols').textContent = data.num_columns || 0;
            document.getElementById('inspectNumRows').textContent = data.num_sample_rows || 0;

            // Display headers as badges
            const headersDiv = document.getElementById('inspectHeaders').querySelector('div');
            headersDiv.innerHTML = '';
            if (data.headers && data.headers.length > 0) {
                data.headers.forEach((header, idx) => {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-primary';
                    badge.textContent = `[${idx}] ${header}`;
                    headersDiv.appendChild(badge);
                });
            } else {
                headersDiv.innerHTML = '<em class="text-muted">No headers found</em>';
            }

            // Display table
            const thead = document.getElementById('inspectTableHead');
            const tbody = document.getElementById('inspectTableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (data.headers && data.headers.length > 0) {
                const headerRow = document.createElement('tr');
                data.headers.forEach((header, idx) => {
                    const th = document.createElement('th');
                    th.textContent = `[${idx}] ${header}`;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
            }

            if (data.sample_rows && data.sample_rows.length > 0) {
                data.sample_rows.forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell || '(empty)';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            } else {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 100;
                td.textContent = 'No data rows found';
                td.className = 'text-muted text-center';
                tr.appendChild(td);
                tbody.appendChild(tr);
            }

            errorDiv.style.display = 'none';
            dataDiv.style.display = 'block';
        }

    } catch (error) {
        errorDiv.textContent = 'Error: ' + error.message;
        errorDiv.style.display = 'block';
        dataDiv.style.display = 'none';
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Inspect Table';
    }
});

// Auto-refresh stats every 30 seconds
setInterval(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}
