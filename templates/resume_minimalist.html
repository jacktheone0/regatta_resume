<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ sailor_name }}'s Minimalist R√©sum√©</title>

  <style>
    @page {
      size: A4;
      margin: 0;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #0077cc;
      margin-bottom: 6px;
    }

    .contact {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }

    hr {
      margin: 24px 0;
    }

    h3 {
      text-align: center;
      color: #0077cc;
      margin: 32px 0 12px;
      page-break-after: avoid;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0 28px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: center;
      vertical-align: top;
      break-inside: avoid;
      page-break-inside: avoid;
    }

    th {
      font-style: italic;
      background-color: #f2f2f2;
      color: #333;
    }

    tbody tr {
      background-color: #e0e0e0;
    }

    tr {
      break-inside: avoid;
      page-break-inside: avoid;
    }

    /* Status bar (editing feedback) */
    .statusbar {
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 16px;
    }

    .row-dirty {
      box-shadow: inset 0 0 0 1px #ffa50066;
    }

    .cell-saving::after { content: ' ‚è≥'; }
    .cell-saved::after  { content: ' ‚úÖ'; }

    /* Back + Download (screen only) */
    .back-link,
    .download-link {
      display: inline-block;
      text-decoration: none;
      border: 1px solid #0077cc;
      padding: 6px 14px;
      border-radius: 4px;
      color: #0077cc;
      font-size: 13px;
      background-color: #f2f8ff;
      transition: 0.2s ease;
    }

    .back-link:hover,
    .download-link:hover {
      background-color: #0077cc;
      color: #fff;
    }

    .back-link {
      position: absolute;
      top: 10px;
      left: 10px;
    }

    .table-gray tbody tr {
      background-color: #e0e0e0;
    }

    .table-blue tbody tr {
      background-color: #d8ecff;
    }
  </style>
</head>

<body>

{% if not pdfrender %}
<a href="{{ url_for('pdf_select', sailor_name=sailor_name) }}" class="back-link">
  ‚Üê Return to Style Selection
</a>
{% endif %}

<h1>{{ sailor_name }}</h1>

<div class="contact">
  <span contenteditable="true">[Class Year]</span> |
  <span contenteditable="true">[Email]</span> |
  <span contenteditable="true">[Phone Number]</span>
</div>

<hr>

<h3>Boat Class Results</h3>

<div class="statusbar" id="saveStatus">
  Click a cell to edit. Press <b>Enter</b> or click away to save.
</div>

{% if techscore_rows %}
  <h4>Techscore Regattas</h4>
  <!-- Gray block table -->
  <table class="results-table table-gray">
    <thead>
      <tr>
        <th>"Class"</th>
        <th>"Regatta"</th>
        <th>"Date"</th>
        <th>"Place"</th>
        <th>"Position"</th>
      </tr>
    </thead>
    <tbody>
      {% for row in techscore_rows %}
      <tr data-rowid="{{ row.RowID }}">
        <td contenteditable="true">{{ row.Source or '' }}</td>
        <td contenteditable="true">{{ row.Regatta or '' }}</td>
        <td contenteditable="true">{{ row.Date or '' }}</td>
        <td contenteditable="true">{{ row.Place or '' }}</td>
        <td contenteditable="true">{{ row.Result or '' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

{% if clubspot_rows %}
  <h4>Clubspot Regattas</h4>
  <!-- Blue block table -->
  <table class="results-table table-blue">
    <thead>
      <tr>
        <th>"Class"</th>
        <th>"Regatta"</th>
        <th>"Date"</th>
        <th>"Place"</th>
        <th>"Position"</th>
      </tr>
    </thead>
    <tbody>
      {% for row in clubspot_rows %}
      <tr data-rowid="{{ row.RowID }}">
        <td contenteditable="true">{{ row.Source or '' }}</td>
        <td contenteditable="true">{{ row.Regatta or '' }}</td>
        <td contenteditable="true">{{ row.Date or '' }}</td>
        <td contenteditable="true">{{ row.Place or '' }}</td>
        <td contenteditable="true">{{ row.Result or '' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

{% if not techscore_rows and not clubspot_rows %}
  <p style="text-align:center; margin-top:20px;">No regatta data to display.</p>
{% endif %}

{% if not pdfrender %}
<div style="text-align:center;">
  <a id="downloadLink"
     href="{{ url_for('download_pdf', sailor_name=sailor_name) }}"
     class="download-link">
    üìÑ Download R√©sum√© as PDF
  </a>
</div>
{% endif %}

<script>
  const FIELD_ORDER = ["Source","Regatta","Date","Place","Result"];
  const saveStatus = document.getElementById('saveStatus');

  function postEdit(rowId, field, value) {
    saveStatus.textContent = 'Saving‚Ä¶';
    return fetch('/apply-edits', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ edits: [{ row: rowId, field, value }] })
    }).then(res => res.json());
  }

  function saveCell(td) {
    const tr = td.closest('tr[data-rowid]');
    if (!tr) return;

    const rowId = parseInt(tr.dataset.rowid, 10);
    const idx = Array.prototype.indexOf.call(tr.children, td);
    const field = FIELD_ORDER[idx];
    if (!field) return;

    const value = td.innerText.trim();
    td.classList.add('cell-saving');

    postEdit(rowId, field, value)
      .then(() => {
        td.classList.remove('cell-saving');
        td.classList.add('cell-saved');
        setTimeout(() => td.classList.remove('cell-saved'), 800);
        saveStatus.textContent = 'Saved ‚úì';
      })
      .catch(() => {
        alert('Save failed');
        td.classList.remove('cell-saving');
      });
  }

  document.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const td = e.target.closest('td[contenteditable]');
      if (!td) return;
      e.preventDefault();
      saveCell(td);
      td.blur();
    }
  });

  document.addEventListener('focusout', e => {
    const td = e.target.closest('td[contenteditable]');
    if (td) saveCell(td);
  });
</script>

</body>
</html>
